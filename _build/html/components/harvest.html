

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DKAN Harvest &mdash; DKAN 1.13 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="DKAN 1.13 documentation" href="../index.html"/>
        <link rel="up" title="Major Components" href="index.html"/>
        <link rel="next" title="DKAN Workflow" href="workflow.html"/>
        <link rel="prev" title="Geocoding" href="datastore/geocoder.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> DKAN
          

          
          </a>

          
            
            
              <div class="version">
                1.13
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">DKAN Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Major Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dataset/index.html">Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore/index.html">Datastore</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Harvester</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#harvest-sources">Harvest Sources</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preview">Preview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-log">Event Log</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-log">Error Log</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manage-datasets-screen">Manage Datasets Screen</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-harvest-dashboard">The Harvest Dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="#harvest-drush-commands">Harvest Drush Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#list-harvest-sources-available">List Harvest sources available</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-a-full-harvest-cache-migration">Run a full harvest (Cache &amp; Migration)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-a-harvest-cache">Run a harvest cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-a-harvest-migration-job">Run a harvest migration job</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#extending-dkan-harvest">Extending DKAN Harvest</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-a-new-harvest-source-type">Define a new Harvest Source Type</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache-callbacks">Cache callbacks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migration-classes">Migration Classes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="topics.html">Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="fixtures.html">Fixtures and Default Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="federal-extras.html">Federal Extras</a></li>
<li class="toctree-l2"><a class="reference internal" href="search.html">Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="theme.html">Theme</a></li>
<li class="toctree-l2"><a class="reference internal" href="permissions.html">Roles and Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="storytelling/index.html">Storytelling</a></li>
<li class="toctree-l2"><a class="reference internal" href="open-data-schema.html">Open Data Schema Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualizations.html">Visualizations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Extending and Customizing DKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apis/index.html">API Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/index.html">Releases</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">DKAN</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Major Components</a> &raquo;</li>
      
    <li>DKAN Harvest</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/components/harvest.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dkan-harvest">
<span id="dkan-harvest"></span><h1>DKAN Harvest<a class="headerlink" href="#dkan-harvest" title="Permalink to this headline">¶</a></h1>
<p>DKAN Harvest is a module that provides a common harvesting framework and for DKAN.
To &#8220;harvest&#8221; data is to use the public feed or API of another data portal to
import items from that portal&#8217;s catalog into your own. To cite a well-known
example, <a class="reference external" href="https://data.gov">Data.gov</a> harvests all of its datasets from the
<a class="reference external" href="https://project-open-data.cio.gov/v1.1/schema/">data.json</a> files of <a class="reference external" href="http://catalog.data.gov/harvest">hundreds
of U.S. federal, state and local data portals</a>.
It supports custom extensions and adds <a class="reference external" href="http://www.drush.org/en/master/">drush</a>
commands and a web UI to manage harvesting sources and jobs.</p>
<p>DKAN Harvest is built on top of the widely-used
<a class="reference external" href="https://www.drupal.org/project/migrate">Migrate</a> framework for Drupal. It
follows a two-step process to import datasets:</p>
<ol class="simple">
<li>Process a source URI and save resulting data locally to disk as JSON</li>
<li>Perform migrations into DKAN with the locally cached JSON files, using mappings provided by the <a class="reference external" href="https://github.com/NuCivic/dkan_migrate_base">DKAN Migrate Base</a> module.</li>
</ol>
<div class="section" id="harvest-sources">
<span id="harvest-sources"></span><h2>Harvest Sources<a class="headerlink" href="#harvest-sources" title="Permalink to this headline">¶</a></h2>
<p>Harvest Sources are nodes that store the source&#8217;s URI and some additional
configuration. To create a new source, make sure you have a role with permissions
to create Harvest Sources (administrators and site managers under default DKAN
Permissions), go to <code class="docutils literal"><span class="pre">node/add/harvest-source</span></code> and fill out the form.</p>
<p>The Harvest Source form includes four multi-value fields to control the results of your harvest.</p>
<ul class="simple">
<li><strong>Filters</strong> restrict the datasets imported by a particular field. For instance, if you are harvesting a data.json source and want only to harvest health-related datasets, you might add a filter with &#8220;keyword&#8221; in the first text box, and &#8220;heatlh&#8221; in the second.</li>
<li><strong>Excludes</strong> are the inverse of filters. For example, if you know there is one
publisher listed on the source whose datasets you do <em>not</em> want to bring into your data portal, you might add &#8220;publisher&#8221; with value &#8220;Governor&#8217;s Office of Terrible Data&#8221;</li>
<li><strong>Overrides</strong> will replace values from the source when you harvest. For instance, if you want to take responsibility for the datasets once harvested and add your agency&#8217;s name as the publisher, you might add &#8220;publisher&#8221; with your agency&#8217;s name as the value.</li>
<li><strong>Defaults</strong>   work the same as overrides, but will only be used if the relevant field is empty in the source</li>
</ul>
<p><img alt="Add Harvest Source" src="https://cloud.githubusercontent.com/assets/381224/20218155/ec7b23b0-a801-11e6-9c07-f27159927ca5.png" /></p>
<p>Project Open Data (as well as most metadata APIs) includes many fields that are not simple key-value pairs. If you need to access or modify nested array values you can use this dot syntax to specify the path: <code class="docutils literal"><span class="pre">key.nested_key.0.other_nested_key</span></code>. For example, the Publisher field in Project Open Data is expressed like this:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span>      &quot;publisher&quot;: {
        &quot;@type&quot;: &quot;org:Organization&quot;,
        &quot;name&quot;: &quot;demo.getdkan.com&quot;
      },
</pre></div>
</div>
<p>To access the name property for filtering or overriding, you can set <code class="docutils literal"><span class="pre">publisher.name</span></code> in the first text box and the value you want to use in the second one.</p>
<p>If the Harvest Source type you are looking for is not available, please refer
to the <strong>Define a new Harvest Source Type</strong> section in the developers docs (coming soon).</p>
<p>Harvest Source nodes are viewable by the public, providing some basic metadata
for the source and listing all datasets harvested from that source.</p>
<p><img alt="Harvest Source Page" src="https://cloud.githubusercontent.com/assets/381224/20218476/93a6196e-a803-11e6-895f-d82d5228b055.png" /></p>
<p>Additional tabs are available to administrators and site managers.</p>
<div class="section" id="preview">
<span id="preview"></span><h3>Preview<a class="headerlink" href="#preview" title="Permalink to this headline">¶</a></h3>
<p>After you create or edit a source, an initial cache operation will be performed and you will be directed to the preview page. This page shows a list of dataset titles and identifiers now in the harvest cache, allowing you to perform a basic check on
your source configuration and make any adjustments before running the migration.</p>
</div>
<div class="section" id="event-log">
<span id="event-log"></span><h3>Event Log<a class="headerlink" href="#event-log" title="Permalink to this headline">¶</a></h3>
<p>The events tab on the Harvest Source page provides historical data on all harvests
run on this source.</p>
<p><img alt="Harvest Source Event Log Page" src="components/images/harvest_source_event_log.png" /></p>
<p>The information is managed by the core <code class="docutils literal"><span class="pre">dkan_harvest</span></code> via a per-harvest source
<code class="docutils literal"><span class="pre">migrate_log</span></code> table that tracks the number of datasets created, updated,
failed, orphaned, and unchanged and status. If the value for the field Status is Error then you can click on the text to see the log error and identify the problem.</p>
</div>
<div class="section" id="error-log">
<span id="error-log"></span><h3>Error Log<a class="headerlink" href="#error-log" title="Permalink to this headline">¶</a></h3>
<p>Similar to the Events tab, this shows a log of all errors recorded during harvesting on the source.</p>
</div>
<div class="section" id="manage-datasets-screen">
<span id="manage-datasets-screen"></span><h3>Manage Datasets Screen<a class="headerlink" href="#manage-datasets-screen" title="Permalink to this headline">¶</a></h3>
<p>An administrative view that lets you sort and filter by certain harvesting metadata. The most powerful function on this page is to filter by &#8220;orphan&#8221; status. When a dataset that was harvested into your system previously is no longer
provided in the source, it is considered &#8220;orphaned&#8221; on your site and unpublished.
From the Manage Datasets screen, you can either permanently delete or re-publish
orphan datasets.</p>
<p>Presenting the event log via some easy to parse charts is in the TODO list.</p>
</div>
</div>
<div class="section" id="the-harvest-dashboard">
<span id="the-harvest-dashboard"></span><h2>The Harvest Dashboard<a class="headerlink" href="#the-harvest-dashboard" title="Permalink to this headline">¶</a></h2>
<p>To run and manage harvest operations from the web interface, navigate to
<code class="docutils literal"><span class="pre">admin/dkan/harvest/dashboard</span></code>. This is a view of all
available (published) Harvest Sources in the system. Apart from the
title and the source type, additonal columns displaying the last time a harvest
migration was run for a specific source and the number of daatsets
imported are available.</p>
<p><img alt="Harvest Dashboard" src="components/images/harvest_dashboard.png" /></p>
<p>The dashboard allows you to select one or more sources and perform one of the following operations on it:</p>
<ul class="simple">
<li><strong>Harvest (cache and migrate)</strong> is the operation you are most likely to want to perform on this page. It will cache the source data locally and migrate that source data into your site content.</li>
<li><strong>Cache source(s)</strong> will simply fetch the source data, apply the source configuration (filters, excludes, etc.) and cache the data locally without migrating. You may wish to do this to check for errors, or to refresh the preview available for each specific source (see the section on source pages below).</li>
<li><strong>Migrate source(s)</strong> will migrate the current cache for the selected sources, no matter how old it is.</li>
</ul>
<p><img alt="Harvest Dashboard Operations" src="components/images/harvest_dashboard_operations.png" /></p>
</div>
<div class="section" id="harvest-drush-commands">
<span id="harvest-drush-commands"></span><h2>Harvest Drush Commands<a class="headerlink" href="#harvest-drush-commands" title="Permalink to this headline">¶</a></h2>
<p>DKAN Harvest provides multiple drush commands to manage harvest sources and
control harvest jobs. In fact, once your sources are properly configured, running
harvests from Drush on a cron job or other scheduling system like <a class="reference external" href="https://jenkins.io/">Jenkins</a> is highly
reccomended.</p>
<p>It is recommanded to pass the <code class="docutils literal"><span class="pre">--user=1</span></code> drush option to
harvest operation (especially harvest migration jobs) to make sure that the
entities created have a proper user as author.</p>
<div class="section" id="list-harvest-sources-available">
<span id="list-harvest-sources-available"></span><h3>List Harvest sources available<a class="headerlink" href="#list-harvest-sources-available" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># List all available Harvest Sources</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest-status
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-hs
</pre></div>
</div>
</div>
<div class="section" id="run-a-full-harvest-cache-migration">
<span id="run-a-full-harvest-cache-migration"></span><h3>Run a full harvest (Cache &amp; Migration)<a class="headerlink" href="#run-a-full-harvest-cache-migration" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Harvest data and run migration on all the harvest sources available.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-h

<span class="c1"># Harvest specific  harvest source.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest test_harvest_source
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-h test_harvest_source
</pre></div>
</div>
</div>
<div class="section" id="run-a-harvest-cache">
<span id="run-a-harvest-cache"></span><h3>Run a harvest cache<a class="headerlink" href="#run-a-harvest-cache" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Run a harvest cache operation on all the harvest sources available.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest-cache
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-hc

<span class="c1"># Harvest cache specific harvest source.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest-cache test_harvest_source
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-hc test_harvest_source
</pre></div>
</div>
</div>
<div class="section" id="run-a-harvest-migration-job">
<span id="run-a-harvest-migration-job"></span><h3>Run a harvest migration job<a class="headerlink" href="#run-a-harvest-migration-job" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Run a harvest migrate operation on all the harvest sources available.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest-migrate
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-hm

<span class="c1"># Harvest migrate specific harvest source.</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-harvest-migrate test_harvest_source
<span class="c1"># Alias</span>
$ drush --user<span class="o">=</span><span class="m">1</span> dkan-hm test_harvest_source
</pre></div>
</div>
</div>
</div>
<div class="section" id="extending-dkan-harvest">
<span id="extending-dkan-harvest"></span><h2>Extending DKAN Harvest<a class="headerlink" href="#extending-dkan-harvest" title="Permalink to this headline">¶</a></h2>
<p>DKAN developers can use the api provided by DKAN Harvest to add support for
additioanl harvest source types. The <code class="docutils literal"><span class="pre">dkan_harvest_datajson</span></code> module encapsulate
the reference implementation providing support for POD type sources.</p>
<p>If you need to harvest from an end point type other then POD. You can extend
the DKAN Harvest APIs to implement said support by following a simple
checklist:</p>
<ul class="simple">
<li>Define a new Harvest Source Type via <code class="docutils literal"><span class="pre">hook_harvest_source_types</span></code>.</li>
<li>Implement the Harvest Source Type cache callback.</li>
<li>Implement the Harvest Source Type Migration Class.</li>
<li>(Optional) Write tests for your source type implementation.</li>
</ul>
<div class="section" id="define-a-new-harvest-source-type">
<span id="define-a-new-harvest-source-type"></span><h3>Define a new Harvest Source Type<a class="headerlink" href="#define-a-new-harvest-source-type" title="Permalink to this headline">¶</a></h3>
<p>DKAN Harvest leverages Drupal&#8217;s hook system to provide a way to extend the
Source types that DKAN Harvest supports. To add a new harvest source type the
we return their definitions as array items via the
<code class="docutils literal"><span class="pre">hook_harvest_source_types()</span></code> hook.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * Implements hook_harvest_source_types().</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">dkan_harvest_test_harvest_source_types</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;harvest_test_type&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;machine_name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;harvest_test_type&#39;</span><span class="p">,</span>
      <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Dkan Harvest Test Type&#39;</span><span class="p">,</span>
      <span class="s1">&#39;cache callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;dkan_harvest_cache_default&#39;</span><span class="p">,</span>
      <span class="s1">&#39;migration class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;HarvestMigration&#39;</span><span class="p">,</span>
    <span class="p">),</span>

    <span class="c1">// Define another harvest source type.</span>
    <span class="s1">&#39;harvest_another_test_type&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;machine_name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;harvest_another_test_type&#39;</span><span class="p">,</span>
      <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Dkan Harvest Another Test Type&#39;</span><span class="p">,</span>
      <span class="s1">&#39;cache callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;dkan_harvest_cache_default&#39;</span><span class="p">,</span>
      <span class="s1">&#39;migration class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;HarvestMigration&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each array item defines a single harvest source type. Each harvest source item consists of an array with 4 keyed values:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">machine_name</span></code> <em>(Unique string identifying the harvest source type.)</em></li>
<li><code class="docutils literal"><span class="pre">label</span></code> <em>(This label wil be used on the harvest add node form.)</em></li>
<li><code class="docutils literal"><span class="pre">cache</span> <span class="pre">callback</span></code> <em>(Cache function to perform; takes HarvestSource object and timestamp as arguments) and returns a HarvestCache object)</em></li>
<li><code class="docutils literal"><span class="pre">migration</span> <span class="pre">class</span></code> <em>(A registered Migrate class to use for this source type)</em></li>
</ul>
</div>
<div class="section" id="cache-callbacks">
<span id="cache-callbacks"></span><h3>Cache callbacks<a class="headerlink" href="#cache-callbacks" title="Permalink to this headline">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * @param HarvestSource $source</span>
<span class="sd"> * @param $harvest_updatetime</span>
<span class="sd"> *</span>
<span class="sd"> * @return HarvestCache</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">dkan_harvest_datajson_cache</span><span class="p">(</span><span class="nx">HarvestSource</span> <span class="nv">$source</span><span class="p">,</span> <span class="nv">$harvest_updatetime</span><span class="p">)</span>
</pre></div>
</div>
<p>This callback takes care of downloading/filtering/altering the data from the
source end-point to the local file directory provided by the
HarvestSource::getCacheDir() method. The recommended folder structure for
cached data is to have one dataset per uniqely named file. The actual migration
is then performed on the cached data, not on the remote source itself.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>$ tree
.
├── 5251bc60-02e2-4023-a3fb-03760551ab4a
├── 80756f84-894f-4796-bb52-33dd0a54164e
├── 846158bd-1821-48d8-80c8-bb23a98294a9
└── 84cada83-2382-4ba2-b9be-97634b422a07

<span class="m">0</span> directories, <span class="m">4</span> files

$ cat 84cada83-2382-4ba2-b9be-97634b422a07
/* JSON content of the cached dataset data */
</pre></div>
</div>
<p>The harvest cache function needs to support the modifications to the source
available from the harvest source via the Filter, Excludes, Overrides and Default
fields. Each of these configurations is available
from the HarvestSource object via the <code class="docutils literal"><span class="pre">HarvestSource::filters</span></code>,
<code class="docutils literal"><span class="pre">HarvestSource::excludes</span></code>, <code class="docutils literal"><span class="pre">HarvestSource::overrides</span></code>,
<code class="docutils literal"><span class="pre">HarvestSource::defaults</span></code> methods.</p>
</div>
<div class="section" id="migration-classes">
<span id="migration-classes"></span><h3>Migration Classes<a class="headerlink" href="#migration-classes" title="Permalink to this headline">¶</a></h3>
<p>The common harvest migration logic is encapsulated in the <a class="reference external" href="https://github.com/NuCivic/dkan/blob/7.x-1.x/modules/dkan/dkan_harvest/dkan_harvest.migrate.inc#L15"><code class="docutils literal"><span class="pre">HarvestMigration</span></code>
class</a>,
(which extends the <a class="reference external" href="https://github.com/NuCivic/dkan/blob/7.x-1.x/modules/dkan/dkan_migrate_base/dkan_migrate_base.migrate.inc#L241">MigrateDKAN</a> class provided
via the <a class="reference external" href="https://github.com/NuCivic/dkan/tree/7.x-1.x/modules/dkan/dkan_migrate_base">DKAN Migrate Base</a>
module. DKAN Harvest will support only migration classes extended from
<code class="docutils literal"><span class="pre">HarvestMigration</span></code>. This class is responsible for consuming the downloaded data
during the harvest cache step to create the DKAN <code class="docutils literal"><span class="pre">dataset</span></code> and associated
nodes.</p>
<p>Implementing a Harvest Source Type Migration class is the matter of checking
couple of boxes:</p>
<ul class="simple">
<li>Wire the cached files on the <code class="docutils literal"><span class="pre">HarvestMigration::__construct()</span></code> method.</li>
<li>Override the fields mapping on the <code class="docutils literal"><span class="pre">HarvestMigration::setFieldMappings()</span></code> method.</li>
<li>Add alternate logic for existing default DKAN fields or extra logic for
custom fields on the <code class="docutils literal"><span class="pre">HarvestMigration::prepareRow()</span></code> and the
<code class="docutils literal"><span class="pre">HarvestMigration::prepare()</span></code>.</li>
</ul>
<p>Working on the Migration Class for Harvest Source Type should be straitforward,
but a good knowladge on how <a class="reference external" href="https://www.drupal.org/node/1006982">migrate
works</a> is a big help.</p>
<div class="section" id="harvestmigration-construct">
<span id="harvestmigration-construct"></span><h4><code class="docutils literal"><span class="pre">HarvestMigration::__construct()</span></code><a class="headerlink" href="#harvestmigration-construct" title="Permalink to this headline">¶</a></h4>
<p>Setting the <code class="docutils literal"><span class="pre">MigrateSourceList</span></code> is the only logic required during the
construction of the extended <code class="docutils literal"><span class="pre">HarvestMigration</span></code>. During the harvest migration
we can&#8217;t reliably determin and parse the type of cache file (JSON, XML, etc..)
so we still need to provide this information to the Migration class via the
<code class="docutils literal"><span class="pre">MigrateItem</span></code> variable. the Migrate module provide different helpful class for
different input file parsing (<code class="docutils literal"><span class="pre">MigrateItemFile</span></code>, <code class="docutils literal"><span class="pre">MigrateItemJSON</span></code>,
<code class="docutils literal"><span class="pre">MigrateItemXML</span></code>). For the the POD <code class="docutils literal"><span class="pre">dkan_harvest_datajson</span></code> reference
implementation we use the <code class="docutils literal"><span class="pre">MigrateItemJSON</span></code> class to read the JSON files
downloaded from data.json end-points.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemUrl</span> <span class="o">=</span> <span class="nx">drupal_realpath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dkanHarvestSource</span><span class="o">-&gt;</span><span class="na">getCacheDir</span><span class="p">())</span> <span class="o">.</span>
    <span class="s1">&#39;/:id&#39;</span><span class="p">;</span>

  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MigrateSourceList</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">HarvestList</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dkanHarvestSource</span><span class="o">-&gt;</span><span class="na">getCacheDir</span><span class="p">()),</span>
    <span class="k">new</span> <span class="nx">MigrateItemJSON</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemUrl</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(),</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sourceListOptions</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="harvestmigration-setfieldmappings">
<span id="harvestmigration-setfieldmappings"></span><h4><code class="docutils literal"><span class="pre">HarvestMigration::setFieldMappings()</span></code><a class="headerlink" href="#harvestmigration-setfieldmappings" title="Permalink to this headline">¶</a></h4>
<p>The default Mapping for all the default DKAN fields and properties is done on
the <code class="docutils literal"><span class="pre">HarvestMigration::setFieldMapping()</span></code> method. Overriding one or many field
mapping is done by overrrding the <code class="docutils literal"><span class="pre">setFieldMapping()</span></code> in the child class and
add/update the new/changed fields.</p>
<p>For example to override the mapping for the <code class="docutils literal"><span class="pre">og_group_ref</span></code> field.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span>  <span class="k">public</span> <span class="k">function</span> <span class="nf">setFieldMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">setFieldMappings</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;og_group_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="resources-import">
<span id="resources-import"></span><h4>Resources import<a class="headerlink" href="#resources-import" title="Permalink to this headline">¶</a></h4>
<p>The base <code class="docutils literal"><span class="pre">HarvestMigration</span></code> class will (by default) look for a <code class="docutils literal"><span class="pre">$row-&gt;resources</span></code> objects
array that should contain all the data needed for constructing the resource
node(s) associated with the dataset. the helper method
<code class="docutils literal"><span class="pre">HarvestMigration::prepareResourceHelper()</span></code> should make creating the
<code class="docutils literal"><span class="pre">resources</span></code> array items more streamlined.</p>
<p>Example code snippet:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * Implements prepareRow.</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">prepareRow</span><span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Redacted code</span>

  <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">resources</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepareRowResources</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="na">xml</span><span class="p">);</span>

  <span class="c1">// Redacted code</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="harvest-and-dkan-workflow-support">
<span id="harvest-and-dkan-workflow-support"></span><h4>Harvest and <a class="reference external" href="https://github.com/NuCivic/dkan_workflow">DKAN Workflow</a> support<a class="headerlink" href="#harvest-and-dkan-workflow-support" title="Permalink to this headline">¶</a></h4>
<p>By default, DKAN Harvest will make sure that the harvested dataset node will be
set to the <code class="docutils literal"><span class="pre">published</span></code> moderation state if the DKAN Workflow module is enabled
on the DKAN site. This can be changed at the fields mapping level by overriding
the <code class="docutils literal"><span class="pre">workbench_moderation_state_new</span></code> field.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="workflow.html" class="btn btn-neutral float-right" title="DKAN Workflow" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="datastore/geocoder.html" class="btn btn-neutral" title="Geocoding" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.13',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>