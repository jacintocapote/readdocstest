

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Open Data Schema Map &mdash; DKAN 1.13 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="DKAN 1.13 documentation" href="../index.html"/>
        <link rel="up" title="Major Components" href="index.html"/>
        <link rel="next" title="Visualization Entities" href="visualizations.html"/>
        <link rel="prev" title="Blog and Comment Modules" href="storytelling/blog-comment.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> DKAN
          

          
          </a>

          
            
            
              <div class="version">
                1.13
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">DKAN Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Major Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dataset/index.html">Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastore/index.html">Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="harvest.html">Harvester</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="topics.html">Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="fixtures.html">Fixtures and Default Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="federal-extras.html">Federal Extras</a></li>
<li class="toctree-l2"><a class="reference internal" href="search.html">Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="theme.html">Theme</a></li>
<li class="toctree-l2"><a class="reference internal" href="permissions.html">Roles and Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="storytelling/index.html">Storytelling</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Open Data Schema Map</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-concepts">Basic concepts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#schema">Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-apis">Creating APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arguments">Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#field-mapping">Field Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#customizing">Customizing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-new-schemas">Adding new schemas</a></li>
<li class="toctree-l4"><a class="reference internal" href="#date-format">Date format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-note-on-xml-output">A Note on XML Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-odsm-file-cache">The ODSM File Cache</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#use">Use</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#schema-validation">Schema Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#community">Community</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="visualizations.html">Visualizations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Extending and Customizing DKAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apis/index.html">API Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/index.html">Releases</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">DKAN</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Major Components</a> &raquo;</li>
      
    <li>Open Data Schema Map</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/components/open-data-schema.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="open-data-schema-map">
<span id="open-data-schema-map"></span><h1>Open Data Schema Map<a class="headerlink" href="#open-data-schema-map" title="Permalink to this headline">¶</a></h1>
<p>This module provides a flexible way to expose your Drupal content via APIs following specific Open Data schemas. Currently, the <a class="reference external" href="http://docs.ckan.org/en/ckan-1.8/domain-model-dataset.html">CKAN</a>, <a class="reference external" href="http://project-open-data.github.io/schema/">Project Open Data</a> and <a class="reference external" href="https://joinup.ec.europa.eu/asset/dcat_application_profile/description">DCAT-AP</a> schemas are provided, but new schemas can be easily added through your own modules. A user interface is in place to create endpoints and map fields from the chosen schema to Drupal content using tokens.</p>
<p>This module was developed as part of the DKAN project, but will work on an Drupal 7 site. A <a class="reference external" href="https://github.com/NuCivic/open_data_schema_map_dkan">separate module exists for DKAN-specific implementation</a>.</p>
<p>Note that serious performance issues can result if you do not follow recommendations in the <a class="reference external" href="#the-odsm-file-cache">ODSM File Cache section</a>.</p>
<div class="section" id="basic-concepts">
<span id="basic-concepts"></span><h2>Basic concepts<a class="headerlink" href="#basic-concepts" title="Permalink to this headline">¶</a></h2>
<div class="section" id="schema">
<span id="schema"></span><h3>Schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h3>
<p>A schema is a list of field definitions, usually representing a community specification for presenting machine-readable data. The core Open Data Schema Map module does not include any schemas; they are provided by additional modules. A schema module includes:</p>
<ul class="simple">
<li>a standard Drupal .module file &#8211; with an implementation of <code class="docutils literal"><span class="pre">hook_open_data_schema()</span></code> to expose the schema to the core Open Data Schema Map module, plus _alter functions for any needed modifications of the UI form or the data output itself.</li>
<li>the schema itself, expressed as a .json file. For instance, see the <a class="reference external" href="https://github.com/NuCivic/open_data_schema_map/blob/master/modules/open_data_schema_pod/data/single_entry.json">Project Open Data schema file</a> to see how these schema are defined in JSON</li>
</ul>
</div>
<div class="section" id="api">
<span id="api"></span><h3>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<p>An API in this module is a configuration set that exposes a specific set of machine-readable data at a specific URL (known as the API&#8217;s endpoint). This module allows you to create multiple APIs that you save as database records and/or export using <a class="reference external" href="http://drupal.org/project/features">Features</a>. An API record will contain:</p>
<ul class="simple">
<li>an endpoint URL</li>
<li>a schema (chosen from the available schemas provided by the additional modules as described above)</li>
<li>a mapping of fields defined in that schema to Drupal tokens (usually referencing fields from a node)</li>
<li>optionally, one or more arguments passed through the URL to filter the result set</li>
</ul>
</div>
</div>
<div class="section" id="usage">
<span id="usage"></span><h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installation">
<span id="installation"></span><h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>Enable the main <em>Open Data Schema Map</em> module as usual, and additionally enable any schema modules you will need to create your API.</p>
</div>
<div class="section" id="creating-apis">
<span id="creating-apis"></span><h3>Creating APIs<a class="headerlink" href="#creating-apis" title="Permalink to this headline">¶</a></h3>
<p>Navigate to admin/config/services/odsm and click &#8220;Add API.&#8221;</p>
<p><img alt="screen shot 2014-07-14 at 3 24 03 pm" src="../_images/c7ff24e6-0b8c-11e4-92c3-9ba2e163bf56.png" /></p>
<p>Give the API a title, machine name, choose which entity type (usually <em>node</em>) and bundle (in <a class="reference external" href="https://github.com/NuCivic/dkan">DKAN</a>, this is usually <em>Dataset</em>).</p>
<p><img alt="screen shot 2014-07-14 at 3 46 39 pm" src="../_images/b3e6ea90-0b8f-11e4-9d9e-33b4515310f0.png" /></p>
<p>You will need to create the API record before adding arguments and mappings.</p>
</div>
<div class="section" id="arguments">
<span id="arguments"></span><h3>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline">¶</a></h3>
<p>The results of the API call can be filtered by a particular field via arguments in the URL. To add an argument, first choose the schema field then, if you are filtering by a custom field API field (ie, a field whose machine name begins with &#8220;field_&#8221;), identify the database column that would contain the actual argument value. Leave off the field name prefix; for instance, if filtering by a DKAN tag (a term reference field), the correct column is field_tags_tid, so you would enter &#8220;tid&#8221;. Which Drupal field to use will be extrapolated from the token you map to that schema field.</p>
<p><img alt="Screen Shot 2014-07-14 at 3.55.49 PM.png | uploaded via ZenHub" src="../_images/992d1138-7ac6-11e4-8e7b-bcaefa733648.png" /></p>
</div>
<div class="section" id="field-mapping">
<span id="field-mapping"></span><h3>Field Mapping<a class="headerlink" href="#field-mapping" title="Permalink to this headline">¶</a></h3>
<p>The API form presents you with a field for each field in your schema. Map the fields using Drupal&#8217;s token system. Note: using more than one token in a single field may produce unexpected results and is not recommended.</p>
<div class="section" id="multi-value-fields">
<span id="multi-value-fields"></span><h4>Multi-value fields<a class="headerlink" href="#multi-value-fields" title="Permalink to this headline">¶</a></h4>
<p>For Drupal multi-value entity reference fields, the schema can use an array to instruct the API to iterate over each value and map the referenced data to multiple schema fields. For instance, in the CKAN schema, tags are described like this in schema_ckan.json:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>      <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Tags&quot;</span><span class="p">,</span>
      <span class="s2">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
          <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;UUID&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
              <span class="p">},</span>
              <span class="s2">&quot;vocabulary_id&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Vocaulary ID&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
              <span class="p">},</span>
              <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
              <span class="p">},</span>
              <span class="s2">&quot;revision_timestamp&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Revision Timestamp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
              <span class="p">},</span>
              <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;uncomplete&quot;</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
</pre></div>
</div>
<p>You can choose which of the available multivalue fields on your selected bundle to map to the &#8220;tags&#8221; array, exposing all of the referenced &#8220;tag&#8221; entities (taxonomy terms in this example) to use as the context for your token mappings on the schema fields within that array. First, simply choose the multivalue field, leaving the individual field mappings blank, and save the form.</p>
<p><img alt="screen shot 2014-07-16 at 12 14 29 am" src="../_images/c3ca9cd4-0c9f-11e4-8fd0-1ea7c3c8b2b3.png" /></p>
<p>When you return to the tags section of the form after saving, you will now see a special token navigator you can use to find tokens that will work with this iterative approach (using &#8220;Nth&#8221; in place of the standard delta value in the token):</p>
<p><img alt="screen shot 2014-07-16 at 12 22 00 am" src="../_images/ad5e3eac-7ac6-11e4-8c7d-91076527c84d.png" /></p>
</div>
</div>
</div>
<div class="section" id="customizing">
<span id="customizing"></span><h2>Customizing<a class="headerlink" href="#customizing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adding-new-schemas">
<span id="adding-new-schemas"></span><h3>Adding new schemas<a class="headerlink" href="#adding-new-schemas" title="Permalink to this headline">¶</a></h3>
<p>You are not limited by the schemas included with this module; any Open Data schema may be defined in a custom module. Use the open_data_schema_ckan module as a model to get started.</p>
</div>
<div class="section" id="date-format">
<span id="date-format"></span><h3>Date format<a class="headerlink" href="#date-format" title="Permalink to this headline">¶</a></h3>
<p>Date formats can be chanaged manually by changing the &#8220;Medium&#8221; date time format in &#8220;admin/config/regional/date-time&#8221; or in code by using one of the alter hooks:
<img alt="screen shot 2014-09-04 at 11 15 01 am" src="../_images/a9cb06b2-344e-11e4-84c8-c2174b5fc566.png" /></p>
</div>
</div>
<div class="section" id="a-note-on-xml-output">
<span id="a-note-on-xml-output"></span><h2>A Note on XML Output<a class="headerlink" href="#a-note-on-xml-output" title="Permalink to this headline">¶</a></h2>
<p>Open Data Schema Map provides an XML output format. This is provided via a separate submodule in the <code class="docutils literal"><span class="pre">modules/</span></code> folder for historical reasons, but should be refactored into the main ODSM module in a future release.</p>
<p>XML endpoints still require a <em>schema</em> defined in JSON. Defining your own XML endpoint may be less than intuitive for the time beind, but take a look at the <a class="reference external" href="https://github.com/NuCivic/open_data_schema_map/tree/master/modules/open_data_schema_dcat">DCAT schema module</a> for a model.</p>
</div>
<div class="section" id="the-odsm-file-cache">
<span id="the-odsm-file-cache"></span><h2>The ODSM File Cache<a class="headerlink" href="#the-odsm-file-cache" title="Permalink to this headline">¶</a></h2>
<p>Open Data Schema Map endpoints that list a large number of entities &#8211; Project Open Data (<code class="docutils literal"><span class="pre">data.json</span></code>), the CKAN Package List (<code class="docutils literal"><span class="pre">/api/3/action/package_list</span></code>) and DCAT-AP Catalog (<code class="docutils literal"><span class="pre">catalog.xml</span></code>) &#8211; perform a full entity load for each record listed in order to perform the token replacements. This can cause a major performance hit each time any of these URLs is hit on a site with more than a few dozen datasets, and on a site with thousands the response time can be two minutes or more.</p>
<p>Open Data Schema Map includes a file caching function to save a snapshot of any endpoint as a static file to be served up quickly, with very few hits to the database.</p>
<p>File caches at present can only be generated by a Drush command. The recommended usage on a production website is to set up a cron job or use a task runner like <a class="reference external" href="https://jenkins.io/">Jenkins</a> to regenerate the file caches for your performance-intensive endpoints daily, at whatever time your site experiences the least amount of traffic. The trade-off of course is that any additions or changes to your site will not be reflected on these endpoints until they are regenerated.</p>
<p>An administrative UI to regenerate a file cache manually may be included in a future release.</p>
<div class="section" id="use">
<span id="use"></span><h3>Use<a class="headerlink" href="#use" title="Permalink to this headline">¶</a></h3>
<p>The Drush command supplied by Open Data Schema Map is <code class="docutils literal"><span class="pre">odsm-filecache</span></code> (also available simply as the alias <code class="docutils literal"><span class="pre">odsmfc</span></code>).  This command takes as  its argument the machine name for an ODSM endpoint.  For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">drush</span> <span class="n">odsm</span><span class="o">-</span><span class="n">filecache</span> <span class="n">data_json_1_1</span>
</pre></div>
</div>
<p>This will render the full <code class="docutils literal"><span class="pre">data_json_1_1</span></code> endpoint (which is the <code class="docutils literal"><span class="pre">data.json</span></code> implementation that ships with DKAN) to the filesystem, saving it to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span><span class="p">:</span><span class="o">//</span><span class="n">odsm_cache_data_json_1_1</span>
</pre></div>
</div>
<p>Now a hit to <code class="docutils literal"><span class="pre">/data.json</span></code> will be routed to this file, which in most cases will actually live at <code class="docutils literal"><span class="pre">/sites/default/files/odsm_cache_data_json_1_1</span></code>.</p>
</div>
</div>
<div class="section" id="schema-validation">
<span id="schema-validation"></span><h2>Schema Validation<a class="headerlink" href="#schema-validation" title="Permalink to this headline">¶</a></h2>
<p>Both the Project Open Data and DCAT-AP schemas ship with validation tools you can access from the Drupal admin menu. More documentation on this feature coming soon...</p>
</div>
<div class="section" id="community">
<span id="community"></span><h2>Community<a class="headerlink" href="#community" title="Permalink to this headline">¶</a></h2>
<p>We are accepting issues for Open Data Schema Map in the <a class="reference external" href="https://github.com/NuCivic/dkan/issues">DKAN issue queue</a> only. Please label your issue as <strong>&#8220;Component: ODSM&#8221;</strong> after submitting so we can identify problems and feature requests faster.</p>
<p>If submitting a pull request to this project, please try to link your PR to the corresponding  issue in the DKAN issue thread.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="visualizations.html" class="btn btn-neutral float-right" title="Visualization Entities" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="storytelling/blog-comment.html" class="btn btn-neutral" title="Blog and Comment Modules" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.13',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>